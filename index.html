<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Subway Surfers by Mynvo</title>
  <meta name="description" content="Subway Surfers version Mynvo - Timer + touches custom + leaderboard manuel">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:Segoe UI,sans-serif;background:linear-gradient(135deg,#5e4fff,#8b5cf6);color:#fff;min-height:100vh;display:flex;flex-direction:column;overflow:hidden;}
    header{background:rgba(0,0,0,0.35);backdrop-filter:blur(12px);padding:18px 40px;position:fixed;top:0;left:0;right:0;z-index:100;}
    .header-content{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;}
    .logo{font-size:34px;font-weight:900;display:flex;align-items:center;gap:14px;}
    .logo img{height:50px;border-radius:50%;border:4px solid #ffd700;box-shadow:0 0 20px #ffd70044;}
    .logo span{color:#ffd700;}
    .nav-links a{color:#fff;text-decoration:none;margin-left:24px;font-weight:600;font-size:17px;transition:0.2s;cursor:pointer;}
    .nav-links a:hover{opacity:0.7;}
    main{flex:1;display:flex;align-items:center;justify-content:center;padding:20px;}
    .game-container{width:100%;max-width:1350px;background:rgba(0,0,0,0.4);backdrop-filter:blur(20px);border-radius:28px;padding:40px;box-shadow:0 25px 80px rgba(0,0,0,0.5);overflow:hidden;position:relative;}
    h1{font-size:56px;text-align:center;margin-bottom:30px;text-shadow:0 6px 30px rgba(0,0,0,0.6);}
    .game-frame{position:relative;border-radius:20px;overflow:hidden;box-shadow:0 15px 50px rgba(0,0,0,0.6);}
    iframe{width:100%;height:720px;border:none;background:#000;display:block;}
    .loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:10;text-align:center;}
    .spinner{width:70px;height:70px;border:8px solid #ffffff33;border-top:8px solid #ffd700;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:20px;}
    @keyframes spin{to{transform:rotate(360deg);}}
    footer{text-align:center;padding:25px;font-size:15px;opacity:0.85;background:rgba(0,0,0,0.2);}

    .fs-button{position:absolute;top:18px;right:18px;z-index:200;background:rgba(0,0,0,0.6);border:2px solid #ffd700;color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;}
    .fs-button:hover{opacity:0.9;}

    #mynvo-settings input{outline:none;}
    #mynvo-settings .small-note{font-size:13px;color:#bbb;margin-top:8px;text-align:center;}

    /* UI overlay sur le jeu */
    #game-ui-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 50;
    }
    #mynvo-timer {
      position: absolute;
      top: 15px;
      left: 15px;
      background: rgba(0,0,0,0.85);
      color: #00ff00;
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 24px;
      font-weight: 700;
      border: 2px solid #00ff00;
      box-shadow: 0 0 20px rgba(0,255,0,0.3);
    }
    #mynvo-fps {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(0,0,0,0.75);
      color: #58a6ff;
      padding: 8px 14px;
      border-radius: 10px;
      font-size: 15px;
      border: 1px solid #58a6ff;
    }
    #mynvo-keys {
      position: absolute;
      bottom: 15px;
      right: 15px;
      background: rgba(0,0,0,0.75);
      color: #58a6ff;
      padding: 8px 14px;
      border-radius: 10px;
      font-size: 15px;
      border: 1px solid #58a6ff;
    }
    #mynvo-lb {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 14px 20px;
      border-radius: 12px;
      border: 2px solid #ffd700;
      font-size: 14px;
      line-height: 1.5;
    }
  </style>
</head>
<body>

  <header>
    <div class="header-content">
      <div class="logo">
        <img src="logo.png" alt="Mynvo" onerror="this.style.display='none'">
        Subway<span>Surfers</span> by <span>Mynvo</span>
      </div>
      <div class="nav-links">
        <a id="play-link">Jouer</a>
        <a onclick="openSettings();return false;">Param√®tres</a>
      </div>
    </div>
  </header>

  <main>
    <div class="game-container">
      <h1>Subway Surfers ‚Äì Mynvo</h1>
      <div class="game-frame">
        <div class="loading" id="loading-ui"><div class="spinner"></div><p>Chargement du jeu...</p></div>
        <button class="fs-button" id="fs-btn" title="Plein √©cran">‚§¢ Plein √©cran</button>
        
        <!-- UI Overlay -->
        <div id="game-ui-overlay">
          <div id="mynvo-timer">0:00</div>
          <div id="mynvo-fps">FPS: --</div>
          <div id="mynvo-keys">ZQSD + ESPACE</div>
          <div id="mynvo-lb">üèÜ TOP 3<br><b>1. Mynvo ‚Äì 18:27</b><br>2. Shadow ‚Äì 14:51<br>3. Ghost ‚Äì 11:09</div>
        </div>
        
        <iframe id="game-iframe" src="./game/" allowfullscreen allow="autoplay; fullscreen *"></iframe>
      </div>
    </div>
  </main>

  <footer>Subway Surfers by Mynvo</footer>

  <script>
    // CONFIG TOUCHES
    let config = JSON.parse(localStorage.getItem("mynvoConfig")) || {
      up: "z", down: "s", left: "q", right: "d", jump: " ", name: "Joueur"
    };
    function saveConfig() { localStorage.setItem("mynvoConfig", JSON.stringify(config)); }

    // DETECT IF TYPING
    function isTyping() {
      const el = document.activeElement;
      if (!el) return false;
      const tag = el.tagName;
      if (tag === "INPUT" || tag === "TEXTAREA") return true;
      if (el.isContentEditable) return true;
      if (document.getElementById('mynvo-settings')?.contains(el)) return true;
      return false;
    }

    // KEY MAPPING
    function getKeyMap() {
      const map = {};
      map[config.up?.toLowerCase() || 'z'] = 'ArrowUp';
      map[config.down?.toLowerCase() || 's'] = 'ArrowDown';
      map[config.left?.toLowerCase() || 'q'] = 'ArrowLeft';
      map[config.right?.toLowerCase() || 'd'] = 'ArrowRight';
      map[' '] = ' '; // Space reste Space
      return map;
    }

    // UPDATE KEYS DISPLAY
    function updateKeysDisplay() {
      const keysEl = document.getElementById('mynvo-keys');
      if (keysEl) {
        const up = (config.up || 'Z').toUpperCase();
        const down = (config.down || 'S').toUpperCase();
        const left = (config.left || 'Q').toUpperCase();
        const right = (config.right || 'D').toUpperCase();
        const jump = config.jump === ' ' ? 'ESPACE' : (config.jump || 'ESPACE').toUpperCase();
        keysEl.textContent = `${left}${up}${down}${right} + ${jump}`;
      }
    }

    // KEYBOARD REMAPPING
    const iframe = document.getElementById('game-iframe');
    
    document.addEventListener('keydown', (e) => {
      if (isTyping()) return;
      const keyMap = getKeyMap();
      const mappedKey = keyMap[e.key.toLowerCase()];
      
      if (mappedKey) {
        e.preventDefault();
        e.stopPropagation();
        
        // Envoyer √† l'iframe
        try {
          iframe.contentWindow.postMessage({
            type: 'keydown',
            key: mappedKey,
            keyCode: mappedKey === 'ArrowUp' ? 38 : mappedKey === 'ArrowDown' ? 40 : mappedKey === 'ArrowLeft' ? 37 : mappedKey === 'ArrowRight' ? 39 : 32
          }, '*');
        } catch (err) {
          console.warn('Cannot send to iframe:', err);
        }
      }
    });

    document.addEventListener('keyup', (e) => {
      if (isTyping()) return;
      const keyMap = getKeyMap();
      const mappedKey = keyMap[e.key.toLowerCase()];
      
      if (mappedKey) {
        e.preventDefault();
        e.stopPropagation();
        
        try {
          iframe.contentWindow.postMessage({
            type: 'keyup',
            key: mappedKey,
            keyCode: mappedKey === 'ArrowUp' ? 38 : mappedKey === 'ArrowDown' ? 40 : mappedKey === 'ArrowLeft' ? 37 : mappedKey === 'ArrowRight' ? 39 : 32
          }, '*');
        } catch (err) {
          console.warn('Cannot send to iframe:', err);
        }
      }
    });

    // FPS COUNTER
    let fpsFrames = 0;
    let fpsLastTime = performance.now();
    function updateFPS() {
      fpsFrames++;
      const now = performance.now();
      if (now - fpsLastTime >= 1000) {
        const fps = Math.round((fpsFrames * 1000) / (now - fpsLastTime));
        const fpsEl = document.getElementById('mynvo-fps');
        if (fpsEl) fpsEl.textContent = `FPS: ${fps}`;
        fpsFrames = 0;
        fpsLastTime = now;
      }
      requestAnimationFrame(updateFPS);
    }
    updateFPS();

    // TIMER (d√©marre automatiquement apr√®s 3 secondes de jeu)
    let timerStarted = false;
    let timerStartTime = 0;
    let timerInterval = null;

    function startTimer() {
      if (timerInterval) return;
      timerStarted = true;
      timerStartTime = Date.now();
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
        const mins = Math.floor(elapsed / 60);
        const secs = (elapsed % 60).toString().padStart(2, '0');
        const timerEl = document.getElementById('mynvo-timer');
        if (timerEl) timerEl.textContent = `${mins}:${secs}`;
      }, 100);
    }

    function resetTimer() {
      timerStarted = false;
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      const timerEl = document.getElementById('mynvo-timer');
      if (timerEl) timerEl.textContent = '0:00';
    }

    // Auto-start timer after 3 seconds (game loaded)
    iframe.addEventListener('load', () => {
      document.getElementById('loading-ui').style.display = 'none';
      setTimeout(() => {
        if (!timerStarted) startTimer();
      }, 3000);
    });

    // FULLSCREEN
    document.getElementById('fs-btn').addEventListener('click', async () => {
      try {
        if (iframe.requestFullscreen) await iframe.requestFullscreen();
        else if (iframe.webkitRequestFullscreen) await iframe.webkitRequestFullscreen();
      } catch (err) {
        alert('Plein √©cran non support√©');
      }
    });

    // SETTINGS MODAL
    function openSettings() {
      if (document.getElementById('mynvo-settings')) return;
      
      const div = document.createElement('div');
      div.id = 'mynvo-settings';
      div.style = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#111;color:#fff;padding:24px 28px;border-radius:16px;border:4px solid #ffd700;z-index:999999;max-width:90%;box-shadow:0 0 80px rgba(0,0,0,0.8);';
      
      div.innerHTML = `
        <h2 style="color:#ffd700;text-align:center;margin-bottom:18px;font-size:22px;">‚öôÔ∏è Param√®tres Mynvo</h2>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;max-width:560px;">
          <div style="grid-column:1/-1"><label style="display:block;margin-bottom:6px;">Pseudo</label><input id="set-name" value="${escapeHtml(config.name)}" style="width:100%;padding:10px;font-size:16px;background:#222;border:2px solid #444;border-radius:10px;color:#fff;"></div>
          <div><label style="display:block;margin-bottom:6px;">Haut</label><input maxlength="1" id="set-up" value="${escapeHtml(config.up)}" style="width:100%;padding:12px;font-size:16px;background:#222;border:2px solid #444;border-radius:10px;color:#fff;text-align:center;"></div>
          <div><label style="display:block;margin-bottom:6px;">Bas</label><input maxlength="1" id="set-down" value="${escapeHtml(config.down)}" style="width:100%;padding:12px;font-size:16px;background:#222;border:2px solid #444;border-radius:10px;color:#fff;text-align:center;"></div>
          <div><label style="display:block;margin-bottom:6px;">Gauche</label><input maxlength="1" id="set-left" value="${escapeHtml(config.left)}" style="width:100%;padding:12px;font-size:16px;background:#222;border:2px solid #444;border-radius:10px;color:#fff;text-align:center;"></div>
          <div><label style="display:block;margin-bottom:6px;">Droite</label><input maxlength="1" id="set-right" value="${escapeHtml(config.right)}" style="width:100%;padding:12px;font-size:16px;background:#222;border:2px solid #444;border-radius:10px;color:#fff;text-align:center;"></div>
          <div style="grid-column:1/-1"><label style="display:block;margin-bottom:6px;">Saut (ESPACE)</label><input id="set-jump" value="${config.jump === ' ' ? 'ESPACE' : escapeHtml(config.jump)}" style="width:100%;padding:12px;font-size:16px;background:#222;border:2px solid #444;border-radius:10px;color:#fff;text-align:center;"></div>
        </div>
        <div style="text-align:center;margin-top:18px;">
          <button id="close-settings" style="background:#ff4444;color:#fff;padding:10px 18px;border:none;border-radius:10px;font-size:16px;cursor:pointer;">Fermer</button>
          <button id="save-settings" style="background:#00ff00;color:#000;padding:10px 22px;border:none;border-radius:10px;font-size:16px;cursor:pointer;margin-left:12px;font-weight:700;">‚úì Enregistrer</button>
        </div>
        <p style="font-size:12px;color:#999;margin-top:12px;text-align:center;">Clique sur un champ et appuie sur la touche voulue</p>
      `;
      
      document.body.appendChild(div);

      // Bind inputs
      function bindKey(el) {
        el.addEventListener('keydown', (e) => {
          e.preventDefault();
          if (e.key === 'Backspace') { el.value = ''; return; }
          if (e.key.length === 1 || e.key === ' ') {
            el.value = e.key === ' ' ? ' ' : e.key;
          }
        });
      }

      bindKey(document.getElementById('set-up'));
      bindKey(document.getElementById('set-down'));
      bindKey(document.getElementById('set-left'));
      bindKey(document.getElementById('set-right'));
      
      const jumpInput = document.getElementById('set-jump');
      jumpInput.addEventListener('keydown', (e) => {
        e.preventDefault();
        if (e.key === 'Backspace') { jumpInput.value = ''; return; }
        jumpInput.value = e.key === ' ' ? 'ESPACE' : e.key;
      });

      document.getElementById('close-settings').onclick = () => div.remove();
      document.getElementById('save-settings').onclick = () => {
        config.name = document.getElementById('set-name').value.trim() || 'Joueur';
        config.up = document.getElementById('set-up').value.charAt(0) || 'z';
        config.down = document.getElementById('set-down').value.charAt(0) || 's';
        config.left = document.getElementById('set-left').value.charAt(0) || 'q';
        config.right = document.getElementById('set-right').value.charAt(0) || 'd';
        
        const jumpVal = document.getElementById('set-jump').value;
        config.jump = jumpVal.toUpperCase() === 'ESPACE' ? ' ' : jumpVal.charAt(0) || ' ';
        
        saveConfig();
        updateKeysDisplay();
        alert('‚úì Param√®tres sauvegard√©s !');
        div.remove();
      };
    }

    function escapeHtml(str) {
      if (!str && str !== '') return '';
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
    }

    // Initialize
    updateKeysDisplay();
    
    document.getElementById('play-link').addEventListener('click', () => {
      document.querySelector('.game-container')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
      iframe.focus();
    });
  </script>
</body>
</html>
