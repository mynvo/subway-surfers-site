<script>
  // ============= CONFIG =============
  let config = {
    up: "z", down: "s", left: "q", right: "d", jump: " ", name: "Joueur"
  };

  try {
    const saved = localStorage.getItem("mynvoConfig");
    if (saved) config = { ...config, ...JSON.parse(saved) };
  } catch(e) {}

  function saveConfig() {
    localStorage.setItem("mynvoConfig", JSON.stringify(config));
  }

  let isCapturingKey = false;
  const iframe = document.getElementById('game-iframe');
  let iframeReady = false;
  let currentCanvas = null;

  // ============= MAPPING KEY → KEYCODE =============
  function getKeyCode(key) {
    const map = {
      'ArrowUp': 38, 'ArrowDown': 40, 'ArrowLeft': 37, 'ArrowRight': 39,
      ' ': 32,
      'z': 90, 'q': 81, 's': 83, 'd': 68,
      'Z': 90, 'Q': 81, 'S': 83, 'D': 68,
      'w': 87, 'a': 65, 'W': 87, 'A': 65
    };
    return map[key] || 0;
  }

  // ============= INJECTION DIRECTE (la méthode qui marche vraiment) =============
  function simulateKey(type, keyName, keyCode) {
    if (!iframeReady || !keyCode) return;

    try {
      const doc = iframe.contentDocument || iframe.contentWindow.document;
      const win = iframe.contentWindow;

      const event = new KeyboardEvent(type, {
        key: keyName,
        code: keyName === ' ' ? 'Space' : keyName,
        keyCode: keyCode,
        which: keyCode,
        bubbles: true,
        cancelable: true
      });

      // On envoie sur tout ce qu’on peut (Unity est capricieux)
      doc.dispatchEvent(event);
      win.dispatchEvent(event);
      if (currentCanvas) currentCanvas.dispatchEvent(event);
      doc.querySelectorAll('canvas').forEach(c => c.dispatchEvent(event));

      // console.log(`✅ ${type}: ${keyName} (code ${keyCode})`);
    } catch (err) {
      // Silencieux en prod
    }
  }

  // ============= DÉTECTION DU CANVAS À CHAQUE CHARGEMENT =============
  iframe.addEventListener('load', () => {
    document.getElementById('loading-ui').style.display = 'none';

    setTimeout(() => {
      try {
        iframe.contentWindow.location; // Test d’accès
        iframeReady = true;
        console.log('%c✅ Iframe accessible → injection directe activée', 'color:lime');

        // Surveille le canvas en continu (important après restart)
        setInterval(() => {
          const canvas = iframe.contentDocument?.querySelector('canvas');
          if (canvas && canvas !== currentCanvas) {
            currentCanvas = canvas;
            console.log('%c Nouveau canvas détecté !', 'color:cyan');
          }
        }, 800);
      } catch (e) {
        console.warn('Iframe bloquée (CORS) → ZQSD ne marchera pas');
        iframeReady = false;
      }
    }, 2500);
  });

  // ============= INTERCEPTION DES TOUCHES (parent) =============
  const keyMap = {
    up: { name: 'ArrowUp', code: 38 },
    down: { name: 'ArrowDown', code: 40 },
    left: { name: 'ArrowLeft', code: 37 },
    right: { name: 'ArrowRight', code: 39 },
    jump: { name: ' ', code: 32 }
  };

  document.addEventListener('keydown', (e) => {
    if (isCapturingKey) return;

    const lowered = e.key.toLowerCase();
    let action = null;

    if (lowered === config.up.toLowerCase()) action = keyMap.up;
    else if (lowered === config.down.toLowerCase()) action = keyMap.down;
    else if (lowered === config.left.toLowerCase()) action = keyMap.left;
    else if (lowered === config.right.toLowerCase()) action = keyMap.right;
    else if (e.key === config.jump) action = keyMap.jump;

    if (action) {
      e.preventDefault();
      simulateKey('keydown', action.name, action.code);
    }
  });

  document.addEventListener('keyup', (e) => {
    if (isCapturingKey) return;

    const lowered = e.key.toLowerCase();
    let action = null;

    if (lowered === config.up.toLowerCase()) action = keyMap.up;
    else if (lowered === config.down.toLowerCase()) action = keyMap.down;
    else if (lowered === config.left.toLowerCase()) action = keyMap.left;
    else if (lowered === config.right.toLowerCase()) action = keyMap.right;
    else if (e.key === config.jump) action = keyMap.jump;

    if (action) {
      e.preventDefault();
      simulateKey('keyup', action.name, action.code);
    }
  });

  // ============= LE RESTE (FPS, fullscreen, settings) → inchangé =============
  // (je te le remets proprement si tu veux, mais il était déjà bon)

  let fpsFrames = 0, fpsLastTime = performance.now();
  function updateFPS() {
    fpsFrames++;
    const now = performance.now();
    if (now - fpsLastTime >= 1000) {
      const fps = Math.round((fpsFrames * 1000) / (now - fpsLastTime));
      document.getElementById('fps-value').textContent = fps;
      const el = document.getElementById('fps-overlay');
      el.style.color = el.style.borderColor = fps >= 55 ? '#22c55e' : fps >= 30 ? '#f59e0b' : '#ef4444';
      fpsFrames = 0; fpsLastTime = now;
    }
    requestAnimationFrame(updateFPS);
  }
  updateFPS();

  document.getElementById('fs-btn').onclick = () => iframe.requestFullscreen?.() || iframe.webkitRequestFullscreen?.();

  document.getElementById('play-link').onclick = () => {
    document.querySelector('.game-container').scrollIntoView({ behavior: 'smooth' });
    setTimeout(() => iframe.focus(), 500);
  };

  // Ton système de settings est nickel → je le garde tel quel
  function openSettings() { /* ... ton code actuel ... */ }
  function escapeHtml(str) { return String(str).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

  // ↑ Colle ici tout le code du modal settings que tu avais (il est parfait)

  console.log('%c[MYNVO] ZQSD activé ! Config:', 'color: lime; font-size: 16px;', config);
</script>
