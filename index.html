<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subway Surfers by Mynvo</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:Segoe UI,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;min-height:100vh;display:flex;flex-direction:column;}
    header{background:rgba(0,0,0,0.3);backdrop-filter:blur(10px);padding:20px 40px;}
    .header-content{max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;}
    .logo{font-size:32px;font-weight:900;display:flex;align-items:center;gap:12px;}
    .logo img{height:48px;border-radius:50%;border:3px solid #ffd700;}
    .logo span{color:#ffd700;}
    .nav-links a{color:#fff;text-decoration:none;margin-left:20px;font-weight:600;}
    main{flex:1;padding:40px 20px;}
    .game-container{max-width:1300px;margin:0 auto;background:rgba(0,0,0,0.3);backdrop-filter:blur(20px);border-radius:24px;padding:40px;box-shadow:0 20px 60px rgba(0,0,0,0.4);}
    h1{font-size:52px;text-align:center;margin-bottom:20px;text-shadow:0 4px 20px rgba(0,0,0,0.5);}
    .game-frame{position:relative;border-radius:16px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.5);}
    iframe{width:100%;height:720px;border:none;}
    .loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:2;text-align:center;}
    .spinner{width:60px;height:60px;border:6px solid #ffffff33;border-top-color:#ffd700;border-radius:50%;animation:s 1s linear infinite;margin-bottom:20px;}
    @keyframes s{to{transform:rotate(360deg);}}
    footer{text-align:center;padding:30px;opacity:0.8;font-size:14px;}
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <img src="logo.png" alt="Mynvo">
        Subway<span>Surfers</span> by <span style="color:#ffd700;font-weight:bold;">Mynvo</span>
      </div>
      <div class="nav-links">
        <a href="#game">Jouer</a>
        <a href="#" onclick="openSettings();return false;">Paramètres</a>
      </div>
    </div>
  </header>

  <main>
    <div class="game-container">
      <h1>Subway Surfers – Timer + Leaderboard Manuel</h1>
      <div class="game-frame">
        <div class="loading"><div class="spinner"></div><p>Chargement...</p></div>
        <iframe src="./game/" allowfullscreen allow="autoplay; fullscreen *"></iframe>
      </div>
    </div>
  </main>

  <footer>© 2025 Subway Surfers by Mynvo – Jeu original © SYBO & Kiloo</footer>

  <script>
    // === CONFIG ===
    let config = JSON.parse(localStorage.getItem("mynvoConfig")) || {up:"z",down:"s",left:"q",right:"d",jump:" ",name:"Joueur"};
    function saveConfig(){localStorage.setItem("mynvoConfig",JSON.stringify(config));}

    // === RECALCUL KEYMAP À CHAQUE FOIS ===
    function getKeyMap(){
      return {
        [config.up.toLowerCase()]: 38,
        [config.down.toLowerCase()]: 40,
        [config.left.toLowerCase()]: 37,
        [config.right.toLowerCase()]: 39,
        [config.jump.toLowerCase()]: 32
      };
    }

    // === REMAP TOUCHES ===
    document.addEventListener("keydown", e => {
      const map = getKeyMap();
      const code = map[e.key.toLowerCase()];
      if(code){
        e.preventDefault();
        const iframe = document.querySelector("iframe");
        if(iframe && iframe.contentWindow) iframe.contentWindow.postMessage({type:"key",code,event:"down"},"*");
      }
    });
    document.addEventListener("keyup", e => {
      const map = getKeyMap();
      const code = map[e.key.toLowerCase()];
      if(code){
        e.preventDefault();
        const iframe = document.querySelector("iframe");
        if(iframe && iframe.contentWindow) iframe.contentWindow.postMessage({type:"key",code,event:"up"},"*");
      }
    });

    // === INJECTION DANS LE JEU ===
    document.querySelector("iframe").addEventListener("load", () => {
      const win = document.querySelector("iframe").contentWindow;
      const script = document.createElement("script");
      script.textContent = `
        (() => {
          // TIMER
          const timer = document.createElement("div");
          timer.style.cssText = "position:fixed;top:15px;left:15px;z-index:99999;background:#000;color:#0f0;font-size:24px;font-weight:bold;padding:10px 20px;border-radius:12px;border:3px solid #0f0;box-shadow:0 0 20px #0f0;";
          timer.textContent = "0:00";
          document.body.appendChild(timer);

          let start = 0, interval = null, running = false;
          function startTimer(){ if(running) return; running=true; start=Date.now(); interval=setInterval(()=>{ let s=Math.floor((Date.now()-start)/1000); let m=Math.floor(s/60); timer.textContent=m+":"+(s%60).toString().padStart(2,"0"); },100); }
          function resetTimer(){ clearInterval(interval); running=false; timer.textContent="0:00"; }

          // FPS
          const fps = document.createElement("div");
          fps.style.cssText = "position:fixed;top:15px;right:15px;z-index:99999;background:#000;color:#58a6ff;padding:8px 14px;border-radius:8px;";
          fps.textContent = "FPS: --";
          document.body.appendChild(fps);
          let last=performance.now(),f=0;
          (function u(){f++;let n=performance.now();if(n-last>=1000){fps.textContent="FPS: "+Math.round(f*1000/(n-last));f=0;last=n;}requestAnimationFrame(u);})();

          // Leaderboard manuel
          const lb = document.createElement("div");
          lb.style.cssText = "position:fixed;bottom:15px;left:15px;z-index:99999;background:#000;color:#fff;padding:12px 20px;border-radius:12px;border:3px solid #ffd700;font-size:16px;";
          lb.innerHTML = "TROPHÉE TOP 3<br>1. Mynvo - 15:42<br>2. Shadow - 11:08<br>3. Ghost - 8:19";
          document.body.appendChild(lb);

          // Touches
          const keys = document.createElement("div");
          keys.textContent = "ZQSD | SPACE";
          keys.style.cssText = "position:fixed;bottom:15px;right:15px;z-index:99999;background:#000;color:#58a6ff;padding:8px 16px;border-radius:12px;";
          document.body.appendChild(keys);

          // Détection score + lancement timer
          let lastScore = 0;
          setInterval(() => {
            const el = document.querySelector("[class*='score'],[class*='Score']");
            if(!el) return;
            const txt = el.textContent.replace(/\\D/g,"");
            const score = txt ? parseInt(txt) : 0;

            if(score > 50 && lastScore <= 50) startTimer();        // partie lancée
            if(score < lastScore - 500) resetTimer();              // mort
            lastScore = score;
          }, 400);

          // Réception des touches depuis la page parent
          window.addEventListener("message", e => {
            if(e.data.type==="key"){
              const ev = e.data.event==="down" ? "keydown" : "keyup";
              document.dispatchEvent(new KeyboardEvent(ev, {keyCode: e.data.code}));
            }
          });
        })();
      `;
      document.querySelector("iframe").contentDocument.head.appendChild(script);
    });

    // === PARAMÈTRES (gros champs + tout fonctionne) ===
    function openSettings(){
      if(document.getElementById("settings")) return;
      const d = document.createElement("div");
      d.id = "settings";
      d.style = "position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#000;color:#fff;padding:40px;border-radius:20px;border:5px solid #ffd700;z-index:999999;width:90%;max-width:560px;box-shadow:0 0 60px #000;";
      d.innerHTML = `
        <h2 style="color:#ffd700;text-align:center;margin-bottom:30px;font-size:30px;">Paramètres MYNVO</h2>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
          <div><label>Pseudo</label><input id="n" value="${config.name}" style="width:100%;padding:14px;margin-top:6px;font-size:18px;background:#111;border:2px solid #333;border-radius:12px;color:#fff;"></div>
          <div><label>Haut</label><input maxlength=1 id="u" value="${config.up}" style="width:100%;padding:14px;margin-top:6px;font-size:18px;background:#111;border:2px solid #333;border-radius:12px;color:#fff;text-align:center;"></div>
          <div><label>Bas</label><input maxlength=1 id="d" value="${config.down}" style="width:100%;padding:14px;margin-top:6px;font-size:18px;background:#111;border:2px solid #333;border-radius:12px;color:#fff;text-align:center;"></div>
          <div><label>Gauche</label><input maxlength=1 id="l" value="${config.left}" style="width:100%;padding:14px;margin-top:6px;font-size:18px;background:#111;border:2px solid #333;border-radius:12px;color:#fff;text-align:center;"></div>
          <div><label>Droite</label><input maxlength=1 id="r" value="${config.right}" style="width:100%;padding:14px;margin-top:6px;font-size:18px;background:#111;border:2px solid #333;border-radius:12px;color:#fff;text-align:center;"></div>
          <div><label>Saut (ou SPACE)</label><input id="j" value="${config.jump===' '?'SPACE':config.jump}" style="width:100%;padding:14px;margin-top:6px;font-size:18px;background:#111;border:2px solid #333;border-radius:12px;color:#fff;text-align:center;"></div>
        </div>
        <div style="text-align:center;margin-top:30px;">
          <button onclick="this.closest('#settings').remove()" style="background:#f44;color:#fff;padding:14px 30px;border:none;border-radius:12px;font-size:18px;cursor:pointer;">Fermer</button>
          <button onclick="saveMynvoSettings()" style="background:#0f0;color:#000;padding:14px 40px;border:none;border-radius:12px;font-size:18px;cursor:pointer;margin-left:20px;">Enregistrer</button>
        </div>
      `;
      document.body.appendChild(d);
    }
    function saveMynvoSettings(){
      config.name = document.getElementById("n").value || "Joueur";
      config.up = document.getElementById("u").value || "z";
      config.down = document.getElementById("d").value || "s";
      config.left = document.getElementById("l").value || "q";
      config.right = document.getElementById("r").value || "d";
      config.jump = document.getElementById("j").value.toUpperCase()==="SPACE" ? " " : document.getElementById("j").value;
      saveConfig();
      alert("Touches sauvegardées ! Recharge la page pour les appliquer.");
      document.getElementById("settings").remove();
    }
  </script>
</body>
</html>
